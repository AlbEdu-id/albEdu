ini isi dari console 
Memuat konfigurasi Firebase AlbEdu...
Firebase berhasil diinisialisasi
Memuat AlByte Guard - Sistem Proteksi AlbEdu...
AlByte Guard siap melindungi AlbEdu!
Firestore offline persistence diaktifkan
Menginisialisasi sistem AlbEdu...
User belum login

system.js
// AlbEdu - AlByte Guard (Level 2)
// Sistem Proteksi Pusat untuk AlbEdu
// Tanggal: ${new Date().toLocaleDateString('id-ID')}

console.log('Memuat AlByte Guard - Sistem Proteksi AlbEdu...');

// Variabel global
let currentUser = null;
let userRole = null;
let userData = null;

// Daftar halaman berdasarkan role
const rolePermissions = {
    'admin': ['/', '/login', '/admin', '/admin/creates', '/admin/panel', '/ujian'],
    'siswa': ['/', '/login', '/siswa', '/ujian']
};

// Fungsi utama untuk inisialisasi sistem
async function initializeSystem() {
    console.log('Menginisialisasi sistem AlbEdu...');
    
    try {
        // Cek status autentikasi
        firebaseAuth.onAuthStateChanged(async (user) => {
            if (user) {
                // User sudah login
                console.log('User terautentikasi:', user.email);
                currentUser = user;
                
                // Ambil data user dari Firestore
                await fetchUserData(user.uid);
                
                // Cek akses halaman
                await checkPageAccess();
                
                // Cek kelengkapan profil (untuk siswa)
                if (userRole === 'siswa' && userData && !userData.profilLengkap) {
                    showProfilePopup();
                }
            } else {
                // User belum login
                console.log('User belum login');
                currentUser = null;
                userRole = null;
                userData = null;
                
                // Redirect ke login jika bukan di halaman login
                if (!isLoginPage()) {
                    redirectToLogin();
                }
            }
        });
        
    } catch (error) {
        console.error('Error inisialisasi sistem:', error);
        showError('Gagal memuat sistem. Silakan refresh halaman.');
    }
}

// Fungsi untuk mengambil data user dari Firestore
async function fetchUserData(userId) {
    try {
        console.log('Mengambil data user dari Firestore...');
        
        const userDoc = await firebaseDb.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            userData = userDoc.data();
            userRole = userData.peran || 'siswa';
            console.log(`Role user: ${userRole}, Data:`, userData);
        } else {
            // Buat data user baru jika belum ada
            console.log('Data user belum ada, membuat data baru...');
            await createUserData(userId);
            await fetchUserData(userId); // Ambil kembali data yang baru dibuat
        }
    } catch (error) {
        console.error('Error mengambil data user:', error);
        showError('Gagal mengambil data pengguna.');
    }
}

// Fungsi untuk membuat data user baru di Firestore
async function createUserData(userId) {
    try {
        const user = firebaseAuth.currentUser;
        
        const newUserData = {
            id: userId,
            nama: user.displayName || '',
            email: user.email,
            foto_profil: user.photoURL || 'https://github.com/identicons/${user.email}.png',
            peran: 'siswa', // Default role adalah siswa
            profilLengkap: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await firebaseDb.collection('users').doc(userId).set(newUserData);
        console.log('Data user baru berhasil dibuat');
    } catch (error) {
        console.error('Error membuat data user:', error);
        throw error;
    }
}

// Fungsi untuk login dengan Google
async function authLogin() {
    try {
        console.log('Memulai proses login dengan Google...');
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');
        
        const result = await firebaseAuth.signInWithPopup(provider);
        console.log('Login berhasil:', result.user.email);
        
        // Redirect berdasarkan role (akan dilakukan oleh onAuthStateChanged)
        return result;
    } catch (error) {
        console.error('Error login:', error);
        
        // Pesan error yang lebih user-friendly
        let errorMessage = 'Terjadi kesalahan saat login';
        
        if (error.code === 'auth/popup-blocked') {
            errorMessage = 'Popup login diblokir oleh browser. Izinkan popup untuk situs ini.';
        } else if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = 'Popup login ditutup sebelum proses selesai.';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Koneksi jaringan terganggu. Periksa koneksi internet Anda.';
        }
        
        throw new Error(errorMessage);
    }
}

// Fungsi untuk logout
async function authLogout() {
    try {
        await firebaseAuth.signOut();
        console.log('Logout berhasil');
        
        // Redirect ke halaman login
        window.location.href = '/login';
    } catch (error) {
        console.error('Error logout:', error);
        showError('Gagal logout. Silakan coba lagi.');
    }
}

// Fungsi untuk mengecek akses halaman
async function checkPageAccess() {
    const currentPath = window.location.pathname;
    console.log(`Mengecek akses untuk path: ${currentPath}, Role: ${userRole}`);
    
    // Jika belum login, redirect ke login
    if (!currentUser) {
        if (!isLoginPage()) {
            redirectToLogin();
        }
        return;
    }
    
    // Jika sudah login dan berada di halaman login, redirect berdasarkan role
    if (isLoginPage()) {
        redirectBasedOnRole();
        return;
    }
    
    // Cek apakah user memiliki akses ke halaman ini
    const allowedPaths = rolePermissions[userRole] || [];
    
    // Normalisasi path (hilangkan .html untuk GitHub Pages)
    const normalizedPath = currentPath.replace('.html', '');
    
    // Cek apakah path diizinkan untuk role ini
    if (!allowedPaths.includes(normalizedPath)) {
        console.warn(`Akses ditolak: Role ${userRole} tidak diizinkan mengakses ${normalizedPath}`);
        showAccessDenied();
        return;
    }
    
    // Double validation: Ambil ulang data dari Firestore untuk memastikan
    try {
        const freshUserData = await firebaseDb.collection('users').doc(currentUser.uid).get();
        if (freshUserData.exists) {
            const freshRole = freshUserData.data().peran;
            
            // Jika role tidak sama dengan yang disimpan di client, tolak akses
            if (freshRole !== userRole) {
                console.warn(`Role mismatch: Client=${userRole}, Server=${freshRole}`);
                showAccessDenied();
                return;
            }
        }
    } catch (error) {
        console.error('Error validasi ganda:', error);
        // Tetap lanjutkan jika validasi gagal (tidak memblokir user)
    }
    
    console.log('Akses diizinkan');
}

// Fungsi untuk redirect berdasarkan role
function redirectBasedOnRole() {
    if (!userRole) return;
    
    let redirectPath = '/login';
    
    switch (userRole) {
        case 'admin':
            redirectPath = '/admin';
            break;
        case 'siswa':
            redirectPath = '/siswa';
            break;
    }
    
    // Tunggu sebentar sebelum redirect agar user melihat loading
    setTimeout(() => {
        window.location.href = redirectPath;
    }, 1000);
}

// Fungsi untuk redirect ke login
function redirectToLogin() {
    if (!isLoginPage()) {
        window.location.href = '/login';
    }
}

// Fungsi untuk mengecek apakah berada di halaman login
function isLoginPage() {
    return window.location.pathname.includes('/login') || 
           window.location.pathname === '/' || 
           window.location.pathname === '/index.html';
}

// Fungsi untuk menampilkan popup profil (untuk siswa)
function showProfilePopup() {
    console.log('Menampilkan popup kelengkapan profil...');
    
    // Buat popup element
    const popup = document.createElement('div');
    popup.id = 'profilePopup';
    popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    popup.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="color: #2563eb; margin-bottom: 15px;">Lengkapi Profil Anda</h3>
            <p style="margin-bottom: 20px; color: #64748b;">Sebelum melanjutkan, mohon lengkapi data profil Anda.</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nama Lengkap</label>
                <input type="text" id="profileName" 
                    style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;"
                    placeholder="Masukkan nama lengkap" value="${userData.nama || ''}">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="skipProfileBtn" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">
                    Lewati
                </button>
                <button id="saveProfileBtn" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Simpan
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Event listeners
    document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
    document.getElementById('skipProfileBtn').addEventListener('click', skipProfile);
    
    // Fungsi untuk menyimpan profil
    async function saveProfile() {
        const nameInput = document.getElementById('profileName');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Nama tidak boleh kosong');
            return;
        }
        
        try {
            // Update data di Firestore
            await firebaseDb.collection('users').doc(currentUser.uid).update({
                nama: name,
                profilLengkap: true,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update data lokal
            userData.nama = name;
            userData.profilLengkap = true;
            
            // Tutup popup
            document.body.removeChild(popup);
            
            alert('Profil berhasil diperbarui!');
            
        } catch (error) {
            console.error('Error menyimpan profil:', error);
            alert('Gagal menyimpan profil. Silakan coba lagi.');
        }
    }
    
    // Fungsi untuk melewatkan pengisian profil
    async function skipProfile() {
        try {
            // Tandai sebagai sudah dilihat
            await firebaseDb.collection('users').doc(currentUser.uid).update({
                profilLengkap: true, // Tetap true agar tidak muncul lagi
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update data lokal
            userData.profilLengkap = true;
            
            // Tutup popup
            document.body.removeChild(popup);
            
        } catch (error) {
            console.error('Error melewatkan profil:', error);
            // Tetap tutup popup meski error
            document.body.removeChild(popup);
        }
    }
}

// Fungsi untuk menampilkan error akses ditolak
function showAccessDenied() {
    // Redirect ke halaman sesuai role
    if (userRole === 'admin') {
        window.location.href = '/admin';
    } else if (userRole === 'siswa') {
        window.location.href = '/siswa';
    } else {
        window.location.href = '/login';
    }
}

// Fungsi untuk menampilkan error
function showError(message) {
    // Buat element error jika belum ada
    let errorDiv = document.getElementById('systemError');
    
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'systemError';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fee2e2;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(errorDiv);
    }
    
    errorDiv.textContent = `Error: ${message}`;
    errorDiv.style.display = 'block';
    
    // Sembunyikan setelah 5 detik
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// Inisialisasi sistem ketika halaman dimuat
document.addEventListener('DOMContentLoaded', () => {
    // Tunggu Firebase siap
    setTimeout(() => {
        if (typeof firebaseAuth !== 'undefined') {
            initializeSystem();
        } else {
            console.error('Firebase tidak terinisialisasi dengan benar');
            showError('Sistem autentikasi tidak tersedia. Silakan refresh halaman.');
        }
    }, 1000);
});

// Export fungsi untuk digunakan di file HTML
window.authLogin = authLogin;
window.authLogout = authLogout;
window.checkPageAccess = checkPageAccess;

console.log('AlByte Guard siap melindungi AlbEdu!');
